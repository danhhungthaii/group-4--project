const { dbConnection } = require('../config/database');
const Role = require('../models/Role');
const User = require('../models/User');

class ProfileManagementTester {
    constructor() {
        this.testResults = [];
        this.testUser = null;
        this.testRole = null;
    }

    log(message, success = true) {
        const status = success ? '‚úÖ' : '‚ùå';
        const logMessage = `${status} ${message}`;
        console.log(logMessage);
        this.testResults.push({ message, success });
    }

    async setupTestData() {
        try {
            console.log('üõ†Ô∏è  Setup: T·∫°o test data cho Profile Management...');
            
            // T·∫°o test role
            this.testRole = await Role.create({
                name: 'profile_test_role',
                description: 'Role cho profile management test',
                permissions: ['read_posts', 'write_posts'],
                isActive: true
            });
            
            // T·∫°o test user
            this.testUser = await User.create({
                username: 'profile_testuser',
                email: 'profile.test@group4.com',
                password: 'testpassword123',
                fullName: 'Profile Test User',
                phoneNumber: '0999888777',
                dateOfBirth: new Date('1995-05-15'),
                gender: 'male',
                role: this.testRole._id,
                isActive: true,
                isVerified: true
            });
            
            this.log('Test data setup th√†nh c√¥ng');
            return true;
        } catch (error) {
            this.log(`Setup test data th·∫•t b·∫°i: ${error.message}`, false);
            return false;
        }
    }

    async testViewProfile() {
        try {
            console.log('\nüë§ Test 1: View Profile...');
            console.log('‚îÄ'.repeat(50));
            
            // Test l·∫•y profile v·ªõi populate role
            const profile = await User.findById(this.testUser._id)
                .populate('role', 'name description permissions')
                .select('-password -verificationToken -resetPasswordToken');
            
            if (profile) {
                this.log('L·∫•y profile th√†nh c√¥ng');
                this.log(`Username: ${profile.username}`);
                this.log(`Full Name: ${profile.fullName}`);
                this.log(`Email: ${profile.email}`);
                this.log(`Role: ${profile.role.name}`);
                this.log(`Phone: ${profile.phoneNumber}`);
                this.log(`Gender: ${profile.gender}`);
                this.log(`Birth Date: ${profile.dateOfBirth?.toLocaleDateString('vi-VN')}`);
            } else {
                this.log('Kh√¥ng l·∫•y ƒë∆∞·ª£c profile', false);
            }
            
            // Test profile statistics
            const accountAge = Math.floor((new Date() - profile.createdAt) / (1000 * 60 * 60 * 24));
            const accountStatus = profile.isActive ? (profile.isVerified ? 'Ho·∫°t ƒë·ªông' : 'Ch∆∞a x√°c th·ª±c') : 'B·ªã kh√≥a';
            
            this.log(`Account Age: ${accountAge} ng√†y`);
            this.log(`Status: ${accountStatus}`);
            
        } catch (error) {
            this.log(`Test View Profile th·∫•t b·∫°i: ${error.message}`, false);
        }
    }

    async testUpdateProfile() {
        try {
            console.log('\n‚úèÔ∏è  Test 2: Update Profile...');
            console.log('‚îÄ'.repeat(50));
            
            // Test c·∫≠p nh·∫≠t th√¥ng tin c∆° b·∫£n
            const updateData = {
                fullName: 'Profile Test User Updated',
                phoneNumber: '0777666555',
                dateOfBirth: new Date('1994-12-25'),
                gender: 'female',
                avatar: 'https://example.com/avatar.jpg'
            };
            
            const updatedProfile = await User.findByIdAndUpdate(
                this.testUser._id,
                updateData,
                { new: true, runValidators: true }
            ).populate('role', 'name description permissions')
             .select('-password -verificationToken -resetPasswordToken');
            
            if (updatedProfile) {
                this.log('C·∫≠p nh·∫≠t profile th√†nh c√¥ng');
                this.log(`New Full Name: ${updatedProfile.fullName}`);
                this.log(`New Phone: ${updatedProfile.phoneNumber}`);
                this.log(`New Gender: ${updatedProfile.gender}`);
                this.log(`New Birth Date: ${updatedProfile.dateOfBirth?.toLocaleDateString('vi-VN')}`);
                
                // Verify changes
                if (updatedProfile.fullName === updateData.fullName) {
                    this.log('Full name ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng');
                } else {
                    this.log('Full name kh√¥ng ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng', false);
                }
                
                if (updatedProfile.phoneNumber === updateData.phoneNumber) {
                    this.log('Phone number ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng');
                } else {
                    this.log('Phone number kh√¥ng ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng', false);
                }
            } else {
                this.log('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t profile', false);
            }
            
        } catch (error) {
            this.log(`Test Update Profile th·∫•t b·∫°i: ${error.message}`, false);
        }
    }

    async testChangePassword() {
        try {
            console.log('\nüîê Test 3: Change Password...');
            console.log('‚îÄ'.repeat(50));
            
            // Test ƒë·ªïi m·∫≠t kh·∫©u
            const currentPassword = 'testpassword123';
            const newPassword = 'newtestpassword456';
            
            // L·∫•y user ƒë·ªÉ test password
            const user = await User.findById(this.testUser._id);
            
            // Verify current password
            const isCurrentValid = await user.comparePassword(currentPassword);
            if (isCurrentValid) {
                this.log('X√°c th·ª±c m·∫≠t kh·∫©u hi·ªán t·∫°i th√†nh c√¥ng');
                
                // Change password
                user.password = newPassword;
                await user.save();
                this.log('L∆∞u m·∫≠t kh·∫©u m·ªõi th√†nh c√¥ng');
                
                // Verify new password
                const updatedUser = await User.findById(this.testUser._id);
                const isNewValid = await updatedUser.comparePassword(newPassword);
                
                if (isNewValid) {
                    this.log('X√°c th·ª±c m·∫≠t kh·∫©u m·ªõi th√†nh c√¥ng');
                } else {
                    this.log('X√°c th·ª±c m·∫≠t kh·∫©u m·ªõi th·∫•t b·∫°i', false);
                }
                
                // Test old password should fail
                const isOldStillValid = await updatedUser.comparePassword(currentPassword);
                if (!isOldStillValid) {
                    this.log('M·∫≠t kh·∫©u c≈© ƒë√£ kh√¥ng c√≤n hi·ªáu l·ª±c (ƒë√∫ng)');
                } else {
                    this.log('M·∫≠t kh·∫©u c≈© v·∫´n c√≤n hi·ªáu l·ª±c (sai)', false);
                }
                
            } else {
                this.log('X√°c th·ª±c m·∫≠t kh·∫©u hi·ªán t·∫°i th·∫•t b·∫°i', false);
            }
            
        } catch (error) {
            this.log(`Test Change Password th·∫•t b·∫°i: ${error.message}`, false);
        }
    }

    async testProfileValidation() {
        try {
            console.log('\n‚úÖ Test 4: Profile Validation...');
            console.log('‚îÄ'.repeat(50));
            
            // Test invalid phone number
            try {
                await User.findByIdAndUpdate(
                    this.testUser._id,
                    { phoneNumber: 'invalid-phone' },
                    { new: true, runValidators: true }
                );
                this.log('Validation kh√¥ng ho·∫°t ƒë·ªông (sai)', false);
            } catch (validationError) {
                this.log('Phone number validation ho·∫°t ƒë·ªông ƒë√∫ng');
            }
            
            // Test invalid email format
            try {
                await User.findByIdAndUpdate(
                    this.testUser._id,
                    { email: 'invalid-email-format' },
                    { new: true, runValidators: true }
                );
                this.log('Email validation kh√¥ng ho·∫°t ƒë·ªông (sai)', false);
            } catch (validationError) {
                this.log('Email validation ho·∫°t ƒë·ªông ƒë√∫ng');
            }
            
            // Test invalid gender
            try {
                await User.findByIdAndUpdate(
                    this.testUser._id,
                    { gender: 'invalid-gender' },
                    { new: true, runValidators: true }
                );
                this.log('Gender validation kh√¥ng ho·∫°t ƒë·ªông (sai)', false);
            } catch (validationError) {
                this.log('Gender validation ho·∫°t ƒë·ªông ƒë√∫ng');
            }
            
        } catch (error) {
            this.log(`Test Profile Validation th·∫•t b·∫°i: ${error.message}`, false);
        }
    }

    async testActivityHistory() {
        try {
            console.log('\nüìä Test 5: Activity History...');
            console.log('‚îÄ'.repeat(50));
            
            // Mock activity history (trong th·ª±c t·∫ø s·∫Ω c√≥ b·∫£ng activity_logs)
            const user = await User.findById(this.testUser._id);
            
            const activities = [
                {
                    action: 'profile_update',
                    description: 'C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n',
                    timestamp: user.updatedAt,
                    status: 'success'
                },
                {
                    action: 'password_change',
                    description: 'ƒê·ªïi m·∫≠t kh·∫©u',
                    timestamp: new Date(),
                    status: 'success'
                },
                {
                    action: 'account_created',
                    description: 'T·∫°o t√†i kho·∫£n',
                    timestamp: user.createdAt,
                    status: 'success'
                }
            ];
            
            // Sort by timestamp descending
            activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            this.log('T·∫°o activity history th√†nh c√¥ng');
            this.log(`T·ªïng s·ªë activities: ${activities.length}`);
            
            activities.forEach((activity, index) => {
                this.log(`${index + 1}. ${activity.description} - ${activity.timestamp.toLocaleString('vi-VN')}`);
            });
            
        } catch (error) {
            this.log(`Test Activity History th·∫•t b·∫°i: ${error.message}`, false);
        }
    }

    async cleanupTestData() {
        try {
            console.log('\nüßπ Cleanup: X√≥a test data...');
            
            if (this.testUser) {
                await User.deleteOne({ _id: this.testUser._id });
                this.log('X√≥a test user th√†nh c√¥ng');
            }
            
            if (this.testRole) {
                await Role.deleteOne({ _id: this.testRole._id });
                this.log('X√≥a test role th√†nh c√¥ng');
            }
            
        } catch (error) {
            this.log(`Cleanup th·∫•t b·∫°i: ${error.message}`, false);
        }
    }

    async runAllTests() {
        try {
            console.log('üöÄ B·∫Øt ƒë·∫ßu ki·ªÉm th·ª≠ Profile Management...\n');
            
            // K·∫øt n·ªëi database
            await dbConnection.connect();
            
            // Setup test data
            const setupSuccess = await this.setupTestData();
            if (!setupSuccess) {
                console.log('‚ùå Kh√¥ng th·ªÉ setup test data, d·ª´ng test');
                return;
            }
            
            // Run tests
            await this.testViewProfile();
            await this.testUpdateProfile();
            await this.testChangePassword();
            await this.testProfileValidation();
            await this.testActivityHistory();
            
            // Cleanup
            await this.cleanupTestData();
            
            // Results
            console.log('\nüìä K·∫æT QU·∫¢ KI·ªÇM TH·ª¨ PROFILE MANAGEMENT:');
            console.log('=' .repeat(60));
            
            const totalTests = this.testResults.length;
            const passedTests = this.testResults.filter(r => r.success).length;
            const failedTests = totalTests - passedTests;
            
            console.log(`T·ªïng s·ªë test: ${totalTests}`);
            console.log(`‚úÖ Passed: ${passedTests}`);
            console.log(`‚ùå Failed: ${failedTests}`);
            console.log(`üìà Success rate: ${((passedTests/totalTests) * 100).toFixed(1)}%`);
            
            if (failedTests > 0) {
                console.log('\n‚ùå FAILED TESTS:');
                this.testResults
                    .filter(r => !r.success)
                    .forEach(r => console.log(`   - ${r.message}`));
            }
            
            console.log('\nüéâ Profile Management testing ho√†n t·∫•t!');
            
        } catch (error) {
            console.error('üí• L·ªói trong qu√° tr√¨nh test:', error.message);
        }
    }
}

// Export tester
const profileTester = new ProfileManagementTester();

// N·∫øu file ƒë∆∞·ª£c ch·∫°y tr·ª±c ti·∫øp
if (require.main === module) {
    (async () => {
        try {
            await profileTester.runAllTests();
        } catch (error) {
            console.error('Profile Management test suite th·∫•t b·∫°i:', error.message);
        } finally {
            await dbConnection.disconnect();
            process.exit(0);
        }
    })();
}

module.exports = profileTester;